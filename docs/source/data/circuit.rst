.. _sec_circuit:

交路数据
---------

在本系统中，\ **交路**\ 是指一组列车形成的\ **有序**\ 序列，通常描述一组列车（车底）依次用于开行一系列的车次。本系统交路中的每个车次可以是\ **实体**\ 车次或者是\ **虚拟**\ 车次。其中，实体车次是指该车次实际存在于本运行图中（本运行图中有该车次的时刻表或运行线），虚拟车次是指该车次不存在于本运行图中，或者没有关联到本运行图中的已有车次。任何车次仅能作为实体车次属于至多一个交路（不允许一个车次同时属于两个或更多的交路）。虚拟车次只是一个占位符，标示交路中存在这个车次，以保证交路的完整性。实体、虚拟车次可以在一定条件下互相转换。

.. note::
    请注意，每个车次最多作为实体车次属于一个交路。这与中国铁路中机辆列车的车底交路类似，与其机车交路不同。

本系统中的交路数据是可选的，可以为列车指定一个交路，或者不指定交路。利用交路数据可以实现以下功能：
- 在运行图上标示出交路中相邻两车次运行线的连线；
- 绘制交路示意图；
- 在列车股道占用分析时提供占用的信息（前序车次终到至后续车次始发间的时间认为占用股道）；
- 提供其他分析，例如交路的累计里程等；
- 提供附加的元数据，例如担当车底型号、担当单位等。

.. note::
    上述功能中的一部分需要交路数据满足特定的条件，见后文。


.. _sec_circuit_add_delete:

交路的增删与管理
~~~~~~~~~~~~~~~~~

与其他基本数据一样，交路的数据也列在运行图资源管理器中。在运行图资源管理器的 ``交路`` 项目上右击，可以添加新的空白交路。在每个交路数据上右击，可以编辑或删除交路。

类似于列车管理面板，我们在运行图资源管理器之外，额外提供了一个 :guilabel:`交路管理` 面板。该面板的开关位于工具栏页面 :guilabel:`列车(3)` 中，默认是停靠面板，其内容如下图所示。其中，每行为一个交路，勾选交路名称前的复选框，可以将该交路的所有车次在运行图上高亮显示（如下图所示）。在面板底部提供了增删以及编辑的按钮。

.. figure:: /_static/img/data/routing-management.png

    交路管理面板

在交路编辑面板或者运行图资源管理器中选中交路项目后，工具栏将出现上下文页面 :guilabel:`交路(0)`，提供对当当前交路数据的操作。

除了手动创建交路外，还可以通过 :ref:`sec_batch_parse_circuit` 功能批量从文本解析并添加交路。


.. _sec_circuit_edit:

交路数据编辑
~~~~~~~~~~~~

在交路管理面板或者运行图资源管理器面板中双击交路名，可打开交路编辑面板，如下图所示。交路编辑面板包含交路全部信息的编辑功能。

.. figure:: /_static/img/data/routing-edit.png

    交路编辑面板

其中，交路名称显示在标题栏，首行可以编辑交路名称。交路名称输入框的右侧有两个按钮，分别可以切换当前面板所编辑的交路，以及令当前面板编辑的交路跟随当前选中的交路（在运行图资源管理器或交路编辑面板中选中）改变。

.. warning::
    如果令当前面板跟随选中的交路切换，则切换时未提交的更改不会保存，可能造成数据丢失，请谨慎操作。

表格中的每一行代表交路中的一个车次。如前所述，每个车次可能是虚拟车次或者实体车次。若是虚拟车次，则 ``虚拟`` 一列会被勾选。通过 :guilabel:`前插` :guilabel:`后插` 按钮可以在当前选中行的前方或后方插入新的车次；通过 :guilabel:`删除` 按钮可删除当前选中的车次；通过 :guilabel:`上移`  :guilabel:`下移` 可以改变车次的顺序。

点击 :guilabel:`前插` 或 :guilabel:`后插` 按钮后，显示如下图所示的对话框，用于添加列车到交路。若要添加的是实体车次，则在车次输入框中输入车次（全车次或一部分），输入完毕后按 :guilabel:`Tab` 键，从下拉菜单中选择匹配的车次。选中车次后，下方的始发站、终到站自动填充，不可编辑。若要添加的是虚拟车次，则直接在 ``虚拟车次`` 单选框后的输入框中输入车次名，可以选择性填写始发站、终到站（虚拟车次的始发、终到站仅用于显示给用户作为参考）。

若勾选 ``开始处连线`` 选项，则程序会尝试在本车次运行线开始处绘制与上一车次运行线结束处的连线。注意，这里绘制连线是有条件的，并非所有情况都会连线。请看对话框中的说明文字。

.. figure:: /_static/img/data/routing-add-train.png

    添加车次到交路


交路编辑的页面同时提供了一些其他操作的按钮，请参阅对应章节： :ref:`sec_routing_parse_text` :ref:`sec_routing_detect_real` :ref:`sec_routing_split` :ref:`sec_routing_miles` .


.. _sec_routing_parse_text:

交路文本解析
~~~~~~~~~~~~

:起始版本: V1.0.0
:工具栏: :guilabel:`交路编辑(0)` 上下文页面 | ``文本解析``
:其他入口: ``交路编辑`` 停靠面板 | ``解析文本``

此提供从文本解析单个交路的数据，从形如 ``C6601-C6602-C6603-C6610`` 的文本中解析交路信息。输入的文本应当是以单一分隔符分隔的一组车次名。分隔符可以由用户指定，在缺省情况下将使用系统内置的几种分隔符。

进入此功能后，显示如下图所示的对话框。在 ``套跑交路文本`` 下的输入框中输入要解析的字符串，点击 :guilabel:`解析` 即可解析其中包含的交路数据，解析结果及过程中的报告将显示在最下方的文字框中。
对于交路文本中的每个车次，系统将首先尝试将其识别为本运行图文件中存在的列车，并将其设置为交路中的实体车次。如果本运行图文件中不存在该车次，或者该车次已经被添加到其他的交路中，则该车次将被作为虚拟车次添加到交路中，此时在解析报告中显示相应的信息。如果勾选 ``仅识别完整车次`` ，则只有文本中的车次名与本运行图中列车的 *完整车次名* 完全一致时，才能识别到该列车；如果不勾选，则当车次名与列车的完整车次、上行或下行车次中的任何一个一致时，都可以识别到。

.. image:: /_static/img/data/routing-parse-text.png

    解析交路文本

此功能有工具栏和交路编辑面板两个入口。从两个入口进入时，其行为有所不同。若从工具栏进入，则从文本解析得到的交路信息直接提交并生效，且覆盖原来的交路信息；若从交路编辑面板进入，则解析的交路信息不覆盖原有交路的已有车次信息，而只是将新解析的车次添加到最后，且并不提交更改，需由用户点击 :guilabel:`确定` 后才生效。

.. _sec_routing_detect_real:

交路车次识别
~~~~~~~~~~~~

.. _sec_batch_parse_circuit:

批量解析交路
~~~~~~~~~~~~

.. _sec_routing_split:

交路拆分
~~~~~~~~~

.. _sec_routing_merge:

交路合并
~~~~~~~~~


.. _sec_routing_miles:

交路里程表
~~~~~~~~~~~

.. _sec_diagram_routing_links:

运行图交路连线
~~~~~~~~~~~~~~~

