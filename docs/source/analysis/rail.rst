
线路车站分析
~~~~~~~~~~~~~

我们将运行图功能大致分为线路部分、列车部分，其中线路部分又分为线路车站、线路断面和线路区间三类。当然，由于运行图数据是相互耦合的，很多分析实际上既涉及到线路，又涉及到列车，不能截然分开，我只能按照我理解的方式大致归类。

股道分析
^^^^^^^^

:起始版本: V1.0.0
:pyETRC对应功能: 车站股道图
:工具栏: :guilabel:`线路工具(8)` 上下文页面 | :guilabel:`股道分析`

股道分析功能是自pyETRC很早版本就存在的功能，并历经多次迭代，从最开始仅支持自动推定股道，到后来也支持手动指定股道；在qETRC开发阶段继续改进和添加了一些功能。股道分析功能主要是支持线路上某一车站的不同股道占用在时间上的分布图，同时提供简单直接的算法，在没有股道数据、或者没有完整股道数据的情况下计算一种股道安排方式，并修改调整以及保存数据。

.. figure:: /_static/img/analysis/track-main.png
    :alt: 股道分析主界面-V1.3.2

选择当前线路上的一个车站后，显示如上图所示的主界面。其中，左侧为配置区，右侧为图形窗口。图形窗口中，横轴为时间（与运行图类似），每一行代表一条股道，每个色块代表一个车次占用本股道的时间段，其颜色由列车运行线颜色决定。将鼠标悬停于色块上可显示时刻信息，以及数据来源（图定或推定）。

几点注记：

* 通过列车的占用时间统一为一分钟。
* 存在 :ref:`交路接续<sec_circuit>` 情况的停车站，占用股道时间为自前车终到起，后车始发止。其色块颜色为后车运行线颜色。
* 股道分析仅能包含图定停车或通过的列车。如果列车时刻表上没有当前站，则不会被包含。若要处理通过列车，请考虑首先使用 :ref:`时刻插值<sec_timetable_interp>` 功能。

股道的 **铺画** 是指将时刻表上各次列车分配到股道上的过程。在qETRC中，铺画有自动和手动两种模式。自动模式是指股道的数量、名称以及列车在股道上的安排全部由本系统内置算法计算得出（并有若干配置参数可以由用户调整）；手动模式是指，首先使用用户提供的数据安排，再由内置算法补全必要的信息，得到完整的股道信息。以下分别说明。

铺画模式和逻辑
''''''''''''''''

左侧的 ``铺画模式`` 设定项给出了三种可能的方式，即手动铺画、单线铺画、双线铺画。其中，单线铺画和双线铺画都是利用本系统的算法自动安排股道，不使用用户提供的股道信息（即使有设置，也会被忽略）；手动铺画模式首先使用用户提供的股道信息，安排给出了股道的车次，然后对于没有安排股道的车次，使用 **单线、允许正线停车** 的算法，自动安排股道。

各种铺画模式下的股道安排、名称及其意义为：

* **单线铺画** 。车站股道依次编排为 ``Ⅰ, 2, 3, ...`` 。其中， ``Ⅰ`` 道称为 **正线** ，其他股道皆称为 **侧线** 。
* **双线铺画** 。车站股道依次编排为 ``..., 3, Ⅰ, Ⅱ, 4, ...`` 。其中， ``Ⅰ, Ⅱ`` 道分别为下行正线和上行正线，其他单数股道为下行侧线，双数股道为上行侧线。在本站运行方向为下行的列车只安排使用下行股道（包括正线、侧线），上行同理。如果存在交路接续的情况，其行别按后续车次决定。
* **手动铺画** 。首先使用车次时刻表中出现过的股道名称，建立相应的股道。无股道信息的列车，首先在已有股道内安排，如果排不下，则建立新的股道。新建股道名称自动编为 ``A1, A2, ...`` 。

.. note::
    请注意qETRC中车站股道名称为 **字符串** ，时刻表中给出的股道名称按 **字符串匹配** 的方式对应到已有股道。这就是说，股道名称不限于数字，并且 ``1`` 和 ``01`` 将指向不同的股道。

使用自动铺画时， ``正线停车`` 选项决定停车列车的安排方式。若选择允许，则停车的列车从正线开始，依次遍历所有股道（双线情况的为同方向的股道），直到能够安排该列车为止；若选择不允许，则停车的列车不考虑安排在正线，而是从第一侧线开始安排。通过的列车总是优先从正线开始安排。

``同向接车间隔`` 规定同一股道上、同行别的两车次的最小间隔。在安排车次时，只有待安排车次与前后的同方向列车距离都不小于此设定项时，才认为不发生冲突。默认值为0，即两列车占用股道时间只要不重叠就可以接受。 ``对向接车间隔`` 相似地适用于同一股道上、不同行别的两车次。

股道名称和顺序编辑
''''''''''''''''''

调整股道名称和顺序有两种方式。

**一是** 与pyETRC相同的自由编辑，仅在手动铺画模式下有效。可在表中自由增加、删除、调整股道名称和顺序，点击 :guilabel:`铺画` 按新的股道次序铺画股道图。有如下的规则：

* 在手动铺画模式下（启动时默认是这样的），如果线路数据中有股道信息、或者用户已经设置过股道信息然后点击铺画，则系统首先将股道信息表中的股道按顺序安排（即使有的股道并没有图定车使用，也会安排）。

* 如果有的车次停站信息中的股道不在股道表中，则在后面追加该股道。增加股道的顺序是不确定的（事实上，取决于扫描车次的顺序）。
    例如，如果某站股道表为Ⅰ, 2, 3，某车次在该站停靠股道为1，则该股道不在股道表中，股道信息将变为Ⅰ, 2, 3, 1。我们再次强调，股道匹配是按照字符串匹配的原则进行的。

* 对于没有股道信息的车次，系统将尝试安排到既有股道；如果既有股道都不能安排该车次，则新建股道，新建股道命名格式为 ``A1, A2, ...`` 。

* 在手动铺画模式下，如果没有输入的股道次序信息（即：线路信息中的股道次序表，或者用户指定的股道次序表），则将所有车次信息中的股道添加到股道表后，进行一次基于字符串比较的排序。


**二是** 仅对股道进行重命名或调整顺序。这是qETRC新增的功能，既可以用在手动铺画中，也可以用于调整自动铺画所得的股道顺序。此时只能调整股道的顺序，或对股道重命名，但这些操作不会触发重新铺画。

.. figure:: /_static/img/analysis/track-adjust.png
    :alt: 调整股道顺序-V1.3.2

点击 ``调整股道次序表`` 后的 :guilabel:`调整` 按钮，弹出对话框如上图所示。双击单元格可以编辑股道名称；点击 :guilabel:`上移` 或 :guilabel:`下移` 可以改变股道顺序。点击 :guilabel:`铺画` 可以更新股道图。

.. warning::
    请注意任何调整都立即生效，且不可撤销，无论是否点击 :guilabel:`铺画` 。更改股道名称时请特别小心，切勿将股道重命名为空白或冲突的名称，否则将导致不确定的结果。



车站时刻表
^^^^^^^^^^^

:起始版本: V1.0.0
:pyETRC对应功能: 车站时刻表
:最后修改: ...
:工具栏: :guilabel:`线路工具(8)` | :guilabel:`车站车次`

车站时刻表功能，或称为车站车次表功能，是提供线路上某一车站的所有 **图定** 列车时刻表的功能。此功能与pyETRC的车站时刻表功能基本一致。

.. figure:: /_static/img/analysis/station-timetable.png
    :alt: 车站时刻表-V1.3.3

打开本功能并选择车站后，显示如上图所示的表格。其中，每一行为一趟列车一次图定经过本站的信息，包含列车的基本信息，到点、开点、股道等。若列车多次经过本站（通常是因为列车折返运行），则每次经过都有一行数据与之对应。

.. tip::
    本功能只包含 **图定** 列车信息，也就是列车时刻表中包含当前车站的情况。对于列车时刻表上没有本站，但运行线跨过本站的情况，本功能 **不会** 推定其通过时刻。
    如需推定这种情况下的通过时刻，请使用车站事件表功能。

车站事件表
^^^^^^^^^^^

间隔分析
^^^^^^^^^

间隔汇总
^^^^^^^^^

线路断面分析
~~~~~~~~~~~~

断面事件表
^^^^^^^^^^^

运行快照
^^^^^^^^^

断面对数表
^^^^^^^^^^^

线路区间分析
~~~~~~~~~~~~

区间对数表
^^^^^^^^^^^

区间车次表
^^^^^^^^^^^


线路拓扑
^^^^^^^^^

